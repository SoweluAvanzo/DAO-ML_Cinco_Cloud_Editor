# ====================================
# General Purpose Jobs
# ====================================

.base-job:
  rules:
    - &rule-schedule
      if: $CI_PIPELINE_SOURCE == "schedule"
    - &rule-cinco-cloud-main-or-mr
      if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH || $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH
      changes:
        - cinco-cloud/**/*

.docker-job:
  image: docker:23.0.2
  services:
    - docker:23.0.2-dind
  variables:
    DOCKER_DRIVER: overlay
    DOCKER_TLS_CERTDIR: /certs

.docker-build-job:
  extends: .docker-job
  variables:
    VERSION: $CI_COMMIT_REF_NAME-$CI_COMMIT_SHA
  script:
    - mkdir "$IMAGE-$VERSION"
    - docker build -t "$CI_REGISTRY_IMAGE/$IMAGE:$VERSION" -t "$CI_REGISTRY_IMAGE/$IMAGE:$TAG" -f "$DOCKERFILE" "$CONTEXT"
    - docker login --username $CI_REGISTRY_USER --password $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker push "$CI_REGISTRY_IMAGE/$IMAGE:$VERSION"
    - docker push "$CI_REGISTRY_IMAGE/$IMAGE:$TAG"

# build without pushing to registry
.docker-build-only-job:
  extends: .docker-job
  variables:
    VERSION: $CI_COMMIT_REF_NAME-$CI_COMMIT_SHA
  script:
    - docker build -f "$DOCKERFILE" "$CONTEXT"

cache:
  key:
    files:
      - ./cinco-cloud/services/main/frontend/package-lock.json
  paths:
    - ./cinco-cloud/services/main/frontend/node_modules/

# ====================================
# Cinco Cloud
# ====================================

.cinco-cloud-default-job-main:
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      changes:
        - cinco-cloud/**/*

.cinco-cloud-default-job-main-or-mr:
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH || $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH
      changes:
        - cinco-cloud/**/*

.cinco-cloud-maven-job:
  image: maven:3.8.1-jdk-11
  services:
    - docker:20.10.6-dind
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .m2/repository
  variables:
    MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
    DOCKER_HOST: "tcp://docker:2375"
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2

.cinco-cloud-deploy-job:
  image:
    name: gcr.io/k8s-skaffold/skaffold:v1.39.0
  script:
    - kubectl config use-context scce/cinco-cloud:k8s-ls-5-de
    - skaffold deploy -p $PROFILE -n $NAMESPACE -t $IMAGE_TAG --status-check=true

.cinco-cloud-node-job-main:
  image: node:18

cinco-cloud-install-main-frontend:
  extends:
    - .cinco-cloud-default-job-main-or-mr
    - .cinco-cloud-node-job-main
  script:
    - cd ./cinco-cloud/services/main/frontend
    - yarn install

cinco-cloud-lint-main-frontend:
  extends:
    - .cinco-cloud-default-job-main-or-mr
    - .cinco-cloud-node-job-main
  needs:
    - cinco-cloud-install-main-frontend
  script:
    - cd ./cinco-cloud/services/main/frontend
    - yarn install
    - yarn lint

cinco-cloud-check-dependencies-main-backend:
  extends:
    - .cinco-cloud-maven-job
  rules:
    - *rule-cinco-cloud-main-or-mr
    - *rule-schedule
  script:
    - cd cinco-cloud/services/main/backend
    - mvn dependency-check:check
  artifacts:
    when: always
    paths:
      - cinco-cloud/services/main/backend/target/dependency-check-junit.xml
      - cinco-cloud/services/main/backend/target/dependency-check-report.html
    reports:
      junit: cinco-cloud/services/main/backend/target/dependency-check-junit.xml

cinco-cloud-lint-main-backend:
  extends:
    - .cinco-cloud-default-job-main-or-mr
    - .cinco-cloud-maven-job
  script:
    - cd ./cinco-cloud/services/main/backend
    - ./mvnw checkstyle:check

cinco-cloud-install-main-backend:
  extends:
    - .cinco-cloud-default-job-main-or-mr
    - .cinco-cloud-maven-job
  needs:
    - cinco-cloud-check-dependencies-main-backend
    - cinco-cloud-lint-main-backend
  script:
    - cd ./cinco-cloud/services/main/backend
    - ./mvnw install -DskipTests

cinco-cloud-test-main-backend:
  extends:
    - .cinco-cloud-default-job-main-or-mr
    - .cinco-cloud-maven-job
  needs:
    - cinco-cloud-install-main-backend
  script:
    - cd ./cinco-cloud/services/main/backend
    - ./mvnw test

cinco-cloud-build-main:
  extends:
    - .cinco-cloud-default-job-main
    - .docker-build-job
  needs:
    - cinco-cloud-test-main-backend
    - cinco-cloud-lint-main-frontend
  variables:
    CONTEXT: ./cinco-cloud/services
    DOCKERFILE: ./cinco-cloud/services/main/Dockerfile
    IMAGE: main
    TAG: latest

cinco-cloud-deploy-testing:
  extends:
    - .cinco-cloud-default-job-main
    - .cinco-cloud-deploy-job
  needs:
    - cinco-cloud-build-main
  variables:
    PROFILE: demo-k8s-ls5
    NAMESPACE: cinco-cloud-demo
    IMAGE_TAG: $CI_COMMIT_REF_NAME-$CI_COMMIT_SHA

deploy-testing-manual:
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH || $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH
  when: manual
  image:
    name: gcr.io/k8s-skaffold/skaffold:v1.39.0
  script:
    - kubectl config use-context scce/cinco-cloud:k8s-ls-5-de
    - skaffold deploy -p demo-k8s-ls5 -n cinco-cloud-demo -t $TAG --status-check=true


# ====================================
# Cinco Cloud Archetype
# ====================================

.archetype-default-job-main:
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      changes:
        - cinco-cloud-archetype/**/*

.archetype-default-job-mr:
  rules:
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH
      changes:
        - cinco-cloud-archetype/**/*

.archetype-default-job-main-or-mr:
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH || $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH
      changes:
        - cinco-cloud-archetype/**/*

.archetype-default-job-feature:
  rules:
    - if: $CI_COMMIT_REF_NAME != $CI_DEFAULT_BRANCH
      changes:
        - cinco-cloud-archetype/**/*

.archetype-test-build-local-job:
  image: node:18-bookworm-slim
  script:
    - apt update
    - apt install -y build-essential zlib1g-dev libncurses5-dev libgdbm-dev libnss3-dev libssl-dev libsqlite3-dev libreadline-dev libffi-dev curl libbz2-dev liblzma-dev libx11-dev libxkbfile-dev libsecret-1-dev git
    - curl -O https://www.python.org/ftp/python/3.9.6/Python-3.9.6.tar.xz
    - tar -xf Python-3.9.6.tar.xz
    - cd Python-3.9.6 && ./configure --enable-optimizations --enable-loadable-sqlite-extensions && make -j 4 && make install && cd ../
    - corepack enable
    - cd ./cinco-cloud-archetype/editor
    - yarn

archetype-test-build-local:
  extends:
    - .archetype-default-job-main-or-mr
    - .archetype-test-build-local-job

archetype-test-build-image:
  extends:
    - .archetype-default-job-mr
    - .docker-build-only-job
  variables:
    CONTEXT: .
    DOCKERFILE: ./cinco-cloud-archetype/Dockerfile

# creates new latest archetype
archetype-build-push-latest:
  extends:
    - .archetype-default-job-main
    - .docker-build-job
  needs:
    - archetype-test-build-local
  variables:
    CONTEXT: .
    DOCKERFILE: ./cinco-cloud-archetype/Dockerfile
    IMAGE: archetype
    TAG: latest

# feature-branch pipeline
archetype-build-push-dev:
  extends:
    - .archetype-default-job-feature
    - .docker-build-job
  when: manual
  variables:
    CONTEXT: .
    DOCKERFILE: ./cinco-cloud-archetype/Dockerfile
    IMAGE: archetype
    TAG: dev

# ====================================
# GitLab Pages
# ====================================

.pages-default-job:
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      changes:
        - docs/**/*

.pages-default-job-main-or-mr:
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH || $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH
      changes:
        - docs/**/*

pages-build:
  extends: .pages-default-job-main-or-mr
  image: 'node:16.15.1'
  cache:
    paths:
      - docs/vuepress/node_modules/
  script:
    - cd docs/vuepress
    - rm src/.vuepress/env.default.js
    - mv src/.vuepress/env.prod.js src/.vuepress/env.default.js
    - npm install
    - npm run build
  artifacts:
    paths:
      - docs/vuepress/src/.vuepress/dist/*
    expire_in: 1 day

pages:
  extends: .pages-default-job
  needs:
    - pages-build
  image: 'node:16.15.1'
  script:
    - mkdir public
    - mv docs/vuepress/src/.vuepress/dist/* public/
  artifacts:
    paths:
      - public
    expire_in: 1 day


# ====================================
# Helm Chart
# ====================================

.helm-job:
  image: 
    name: alpine/helm:3.9.2
    entrypoint: [""] 
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH || $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH
      changes:
        - infrastructure/**/*
  before_script:
    - cd infrastructure/helm
    - rm values-*.yaml

helm-lint:
  extends: .helm-job
  script:
    - helm dependency update .
    - helm lint .

helm-package:
  extends: .helm-job
  needs:
    - helm-lint
  script:
    # install sub charts
    - helm dependency update .
    # Extract current chart version
    - CHART_VERSION=$(grep 'version:' Chart.yaml | head -n 1 | awk '{print $2}')
    # Combine chart version with commit hash
    - PACKAGE_VERSION=${CHART_VERSION}-${CI_COMMIT_SHORT_SHA}
    # Package the helm chart with the appended version
    - helm package . --version ${PACKAGE_VERSION}
  artifacts:
    paths:
      - infrastructure/helm/*.tgz
    expire_in: '1 day'

helm-push:
  image: curlimages/curl:latest
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      changes:
        - infrastructure/**/*
  needs: 
    - helm-package
  script:
    # Extract current chart version
    - CHART_VERSION=$(grep 'version:' infrastructure/helm/Chart.yaml | head -n 1 | awk '{print $2}')
    # Combine chart version with commit hash
    - PACKAGE_VERSION=${CHART_VERSION}-${CI_COMMIT_SHORT_SHA}
    # Use the PACKAGE_VERSION for the curl POST request
    - curl --request POST --user gitlab-ci-token:$CI_JOB_TOKEN --form "chart=@infrastructure/helm/cincocloud-${PACKAGE_VERSION}.tgz" "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/helm/api/stable/charts"
