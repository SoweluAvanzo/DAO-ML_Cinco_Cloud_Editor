# ====================================
# General Purpose Jobs
# ====================================

.docker-job:
  image: docker:20.10.6
  services:
    - docker:20.10.6-dind
  variables:
    DOCKER_DRIVER: overlay

.docker-build-job:
  extends: .docker-job
  script:
    - mkdir "$IMAGE-$VERSION"
    - docker build -t "$CI_REGISTRY_IMAGE/$IMAGE:$VERSION" -f "$DOCKERFILE" "$CONTEXT"
    - docker save "$CI_REGISTRY_IMAGE/$IMAGE:$VERSION" | gzip > "$IMAGE-$VERSION/image.tar.gz"
  artifacts:
    expire_in: 1 days
    paths:
      - $IMAGE-$VERSION/image.tar.gz

.docker-push-job:
  extends: .docker-job
  before_script:
    - docker login --username $CI_REGISTRY_USER --password $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker load < $IMAGE-$VERSION/image.tar.gz
    - |
      for TAG in $PUSH_TAGS
        do
          docker tag $CI_REGISTRY_IMAGE/$IMAGE:$VERSION $CI_REGISTRY_IMAGE/$IMAGE:$TAG
          docker push $CI_REGISTRY_IMAGE/$IMAGE:$TAG
        done

cache:
  key:
    files:
      - ./cinco-cloud/services/main/frontend/package-lock.json
  paths:
    - ./cinco-cloud/services/main/frontend/node_modules/

# ====================================
# Cinco Cloud
# ====================================

.cinco-cloud-default-job-main:
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      changes:
        - cinco-cloud/**/*

.cinco-cloud-default-job-main-or-mr:
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH || $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH
      changes:
        - cinco-cloud/**/*

.cinco-cloud-maven-job:
  image: maven:3.8.1-jdk-11
  services:
    - docker:20.10.6-dind
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .m2/repository
  variables:
    MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
    DOCKER_HOST: "tcp://docker:2375"
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2

.cinco-cloud-deploy-job:
  image:
    name: gcr.io/k8s-skaffold/skaffold:v1.27.0
  script:
    - kubectl config use-context scce/cinco-cloud:k8s-ls-5-de
    - skaffold deploy -p $PROFILE -n $NAMESPACE -t $TAG --status-check=true

.cinco-cloud-node-job-main:
  image: node:16.14.0

cinco-cloud-install-main-frontend:
  extends:
    - .cinco-cloud-default-job-main-or-mr
    - .cinco-cloud-node-job-main
  script:
    - cd ./cinco-cloud/services/main/frontend
    - npm install

cinco-cloud-lint-main-frontend:
  extends:
    - .cinco-cloud-default-job-main-or-mr
    - .cinco-cloud-node-job-main
  needs:
    - cinco-cloud-install-main-frontend
  script:
    - cd ./cinco-cloud/services/main/frontend
    - npm install
    - npm run lint

cinco-cloud-lint-main-backend:
  extends:
    - .cinco-cloud-default-job-main-or-mr
    - .cinco-cloud-maven-job
  script:
    - cd ./cinco-cloud/services/main/backend
    - ./mvnw checkstyle:check

cinco-cloud-install-main-backend:
  extends:
    - .cinco-cloud-default-job-main-or-mr
    - .cinco-cloud-maven-job
  needs:
    - cinco-cloud-lint-main-backend
  script:
    - cd ./cinco-cloud/services/main/backend
    - ./mvnw install -DskipTests

cinco-cloud-test-main-backend:
  extends:
    - .cinco-cloud-default-job-main-or-mr
    - .cinco-cloud-maven-job
  needs:
    - cinco-cloud-install-main-backend
  script:
    - cd ./cinco-cloud/services/main/backend
    - ./mvnw test

cinco-cloud-build-main:
  extends:
    - .cinco-cloud-default-job-main
    - .docker-build-job
  needs:
    - cinco-cloud-test-main-backend
    - cinco-cloud-lint-main-frontend
  variables:
    CONTEXT: ./cinco-cloud/services
    DOCKERFILE: ./cinco-cloud/services/main/Dockerfile
    IMAGE: main
    VERSION: latest

cinco-cloud-lint-workspace-builder-backend:
  extends:
    - .cinco-cloud-default-job-main-or-mr
    - .cinco-cloud-maven-job
  script:
    - cd ./cinco-cloud/services/workspace-builder
    - mvn checkstyle:check

cinco-cloud-install-workspace-builder-backend:
  extends:
    - .cinco-cloud-default-job-main-or-mr
    - .cinco-cloud-maven-job
  needs:
    - cinco-cloud-lint-workspace-builder-backend
  script:
    - cd ./cinco-cloud/services/workspace-builder
    - mvn install -DskipTests

cinco-cloud-build-workspace-builder:
  extends:
    - .cinco-cloud-default-job-main
    - .docker-build-job
  needs:
    - cinco-cloud-install-workspace-builder-backend
  variables:
    CONTEXT: ./cinco-cloud/services
    DOCKERFILE: ./cinco-cloud/services/workspace-builder/Dockerfile
    IMAGE: workspace-builder
    VERSION: latest

.cinco-cloud-push-image-job:
  extends:
    - .cinco-cloud-default-job-main
    - .docker-push-job
  needs:
    - cinco-cloud-build-main
    - cinco-cloud-build-workspace-builder

cinco-cloud-push-image-main:
  extends:
    - .cinco-cloud-default-job-main
    - .cinco-cloud-push-image-job
  variables:
    IMAGE: main
    VERSION: latest
    PUSH_TAGS: latest $CI_COMMIT_REF_NAME-$CI_COMMIT_SHA

cinco-cloud-push-image-workspace-builder:
  extends:
    - .cinco-cloud-default-job-main
    - .cinco-cloud-push-image-job
  variables:
    IMAGE: workspace-builder
    VERSION: latest
    PUSH_TAGS: latest $CI_COMMIT_REF_NAME-$CI_COMMIT_SHA

cinco-cloud-deploy-testing:
  extends:
    - .cinco-cloud-default-job-main
    - .cinco-cloud-deploy-job
  needs:
    - cinco-cloud-push-image-main
    - cinco-cloud-push-image-workspace-builder
  variables:
    PROFILE: demo-k8s-ls5
    NAMESPACE: cinco-cloud-demo
    TAG: $CI_COMMIT_REF_NAME-$CI_COMMIT_SHA


# ====================================
# Cinco Cloud Archetype
# ====================================

.archetype-job:
  before_script:
    - cp -r cinco-language-server cinco-cloud-archetype/cinco-ls

.archetype-default-job-main:
  extends: .archetype-job
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      changes:
        - cinco-language-server/**/*
        - cinco-cloud-archetype/**/*

.archetype-default-job-main-or-mr:
  extends: .archetype-job
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH || $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH
      changes:
        - cinco-language-server/**/*
        - cinco-cloud-archetype/**/*

.archetype-default-job-feature:
  extends: .archetype-job
  rules:
    - if: $CI_COMMIT_REF_NAME != $CI_DEFAULT_BRANCH
      changes:
        - cinco-language-server/**/*
        - cinco-cloud-archetype/**/*

.archetype-theia-extension-build-job:
  image: node:14.18-buster-slim
  cache:
    paths:
      - ./cinco-cloud-archetype/vscode-extensions/$EXTENSION_DIR/node_modules
  script:
    - cd ./cinco-cloud-archetype/vscode-extensions/$EXTENSION_DIR
    - npm install -g vsce --unsafe-perm
    - yarn

archetype-test-build-cinco-extension:
  extends:
    - .archetype-default-job-main-or-mr
    - .archetype-theia-extension-build-job
  variables:
    EXTENSION_DIR: cinco-extension

archetype-test-build-cinco-project-initializer-extension:
  extends:
    - .archetype-default-job-main-or-mr
    - .archetype-theia-extension-build-job
  variables:
    EXTENSION_DIR: cinco-project-initializer

archetype-test-build-pyro-client-extension:
  extends:
    - .archetype-default-job-main-or-mr
    - .archetype-theia-extension-build-job
  variables:
    EXTENSION_DIR: pyro-client-extension

archetype-build:
  extends:
    - .archetype-default-job-main
    - .docker-build-job
  needs:
    - archetype-test-build-cinco-extension
    - archetype-test-build-cinco-project-initializer-extension
    - archetype-test-build-pyro-client-extension
    - cinco-ls-test-compile-frontend
    - cinco-ls-test-compile-backend
  variables:
    CONTEXT: .
    DOCKERFILE: ./cinco-cloud-archetype/Dockerfile
    IMAGE: archetype
    VERSION: latest

archetype-push:
  extends:
    - .archetype-default-job-main
    - .docker-push-job
  needs:
    - archetype-build
  variables:
    IMAGE: archetype
    VERSION: latest
    PUSH_TAGS: latest $CI_COMMIT_REF_NAME-$CI_COMMIT_SHA

# feature-branch pipeline
archetype-build-dev:
  extends:
    - .archetype-default-job-feature
    - .docker-build-job
  when: manual
  variables:
    CONTEXT: .
    DOCKERFILE: ./cinco-cloud-archetype/Dockerfile
    IMAGE: archetype
    VERSION: dev

archetype-push-dev:
  extends:
    - .archetype-default-job-feature
    - .docker-push-job
  needs:
    - archetype-build-dev
  variables:
    IMAGE: archetype
    VERSION: dev
    PUSH_TAGS: $CI_COMMIT_REF_NAME-$CI_COMMIT_SHA


# ====================================
# Cinco Language Server
# ====================================

.cinco-ls-default-job:
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH || $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH
      changes:
        - cinco-language-server/**/*
        - cinco-cloud-archetype/**/*

.cinco-ls-maven-job:
  image: maven:3.8.1-jdk-11
  cache:
    paths:
      - .m2/repository
  variables:
    MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"

.cinco-ls-dart-job:
  image: google/dart:2.4.1
  cache:
    paths:
      - /root/.pub-cache

cinco-ls-install:
  extends:
    - .cinco-ls-default-job
    - .cinco-ls-maven-job
  script:
    - cd ./cinco-language-server
    - mvn clean install
  artifacts:
    expire_in: 1 days
    paths:
      - ./cinco-language-server/de.jabc.cinco.meta.productdefinition.ide/test-data/pyro/*

cinco-ls-test-compile-frontend:
  extends:
    - .cinco-ls-default-job
    - .cinco-ls-dart-job
  needs:
    - cinco-ls-install
  script:
    - cd ./cinco-language-server/de.jabc.cinco.meta.productdefinition.ide/test-data/pyro/webapp
    - pub global activate webdev && pub get && /root/.pub-cache/bin/webdev build

cinco-ls-test-compile-backend:
  extends:
    - .cinco-ls-default-job
    - .cinco-ls-maven-job
  needs:
    - cinco-ls-install
  script:
    - cd ./cinco-language-server/de.jabc.cinco.meta.productdefinition.ide/test-data/pyro/app
    - mvn clean package -DskipTests


# ====================================
# GitLab Pages
# ====================================

.pages-default-job:
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      changes:
        - docs/**/*

.pages-default-job-main-or-mr:
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH || $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH
      changes:
        - docs/**/*

pages-build:
  extends: .pages-default-job-main-or-mr
  image: 'node:16.15.1'
  cache:
    paths:
      - docs/vuepress/node_modules/
  script:
    - cd docs/vuepress
    - rm src/.vuepress/env.default.js
    - mv src/.vuepress/env.prod.js src/.vuepress/env.default.js
    - npm install
    - npm run build
  artifacts:
    paths:
      - docs/vuepress/src/.vuepress/dist/*
    expire_in: 1 day

pages:
  extends: .pages-default-job
  needs:
    - pages-build
  image: 'node:16.15.1'
  script:
    - mkdir public
    - mv docs/vuepress/src/.vuepress/dist/* public/
  artifacts:
    paths:
      - public
    expire_in: 1 day


# ====================================
# Helm Chart
# ====================================

.helm-job:
  image: 
    name: alpine/helm:3.9.2
    entrypoint: [""] 
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH || $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH
      changes:
        - infrastructure/**/*
  before_script:
    - cd infrastructure/helm
    - rm values-*.yaml

helm-lint:
  extends: .helm-job
  script:
    - helm lint .

helm-package:
  extends: .helm-job
  needs:
    - helm-lint
  script:
    - helm package .
  artifacts:
    paths:
      - infrastructure/helm/*.tgz
    expire_in: '1 day'

helm-push:
  image: curlimages/curl:latest
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      changes:
        - infrastructure/**/*
  needs: 
    - helm-package
  script:
    - CHART_VERSION=$(find . -name cincocloud-*.tgz | grep -Eo "([0-9]+.[0-9]+.[0-9]+)")
    - curl --request POST --user gitlab-ci-token:$CI_JOB_TOKEN --form "chart=@infrastructure/helm/cincocloud-${CHART_VERSION}.tgz" "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/helm/api/stable/charts"
